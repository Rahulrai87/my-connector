import { Injectable, Logger } from '@nestjs/common';
import { InjectModel } from '@nestjs/mongoose';
import { Model } from 'mongoose';

import { Connector } from './connector.schema';
import { ConnectorState } from './connector-state.schema';
import { ConnectorSnapshot } from './connector-snapshot.schema';
import { ConnectorRun } from './connector-run.schema';
import { GraphService } from './graph/graph.service';
import { parseSharePointUrl } from './sharepoint-url.util';

@Injectable()
export class ConnectorRunner {
  private readonly logger = new Logger(ConnectorRunner.name);

  constructor(
    private readonly graph: GraphService,

    @InjectModel(Connector.name)
    private readonly connectorModel: Model<Connector>,

    @InjectModel(ConnectorState.name)
    private readonly stateModel: Model<ConnectorState>,

    @InjectModel(ConnectorSnapshot.name)
    private readonly snapshotModel: Model<ConnectorSnapshot>,

    @InjectModel(ConnectorRun.name)
    private readonly runModel: Model<ConnectorRun>,
  ) {}

  /**
   * One execution of a connector
   * Called ONLY by cron
   */
  async run(connectorId: string) {
    const connector =
      await this.connectorModel.findById(connectorId);

    if (!connector) return;

    this.logger.log(
      `Running connector ${connectorId}`,
    );

    const state =
      await this.stateModel.findOne({ connectorId });

    const { siteBaseUrl } =
      parseSharePointUrl(connector.siteUrl);

    const siteId = await this.graph.getSiteId(siteBaseUrl);
    const driveId = await this.graph.getDriveId(siteId);

    let added = 0;
    let updated = 0;
    let deleted = 0;
    let unchanged = 0;

    const delta = await this.graph.delta(
      driveId,
      state?.deltaToken,
    );

    for (const item of delta.items) {
      // Deleted file
      if (item.deleted) {
        const res =
          await this.snapshotModel.deleteOne({
            connectorId,
            fileId: item.id,
          });
        if (res.deletedCount) deleted++;
        continue;
      }

      // Ignore folders
      if (!item.file) continue;

      const existing =
        await this.snapshotModel.findOne({
          connectorId,
          fileId: item.id,
        });

      const lastModified = new Date(
        item.lastModifiedDateTime!,
      );

      // New file
      if (!existing) {
        await this.snapshotModel.create({
          connectorId,
          fileId: item.id,
          path: item.parentReference?.path,
          lastModified,
          eTag: item.eTag,
        });
        added++;
        continue;
      }

      // Updated file
      if (
        existing.eTag !== item.eTag ||
        existing.lastModified < lastModified
      ) {
        existing.lastModified = lastModified;
        existing.eTag = item.eTag;
        await existing.save();
        updated++;
      } else {
        unchanged++;
      }
    }

    // Persist delta cursor
    await this.stateModel.updateOne(
      { connectorId },
      {
        deltaToken: delta.nextDelta,
        deltaBroken: false,
      },
    );

    // Save run metrics
    await this.runModel.create({
      connectorId,
      added,
      updated,
      deleted,
      unchanged,
      total: added + updated + deleted + unchanged,
      runAt: new Date(),
    });

    this.logger.log(
      `Run completed for ${connectorId}`,
    );
  }
}
